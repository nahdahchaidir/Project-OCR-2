<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PLN</title>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Iconify -->
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>

  <style>
    :root{
      --bg:#0097a7;
      --card:#ffffff;
      --muted:#667085;
      --text:#101828;

      --primary:#2f80ff;
      --primary2:#1f66db;

      --success:#22c55e;
      --danger:#ef4444;
      --gray:#6b7280;

      --border:#e6e6e6;
      --shadow:0 8px 24px rgba(0,0,0,0.10);
      --radius:14px;

      /* sidebar palette */
      --sb-bg1:#071a33;
      --sb-bg2:#061b3a;
      --sb-bg3:#052b55;
      --sb-text:#e5e7eb;
      --sb-accent:#2f80ff;
      --sb-item: rgba(255,255,255,.06);
      --sb-item2: rgba(255,255,255,.10);
      --sb-active: rgba(47,128,255,.14);
      --sb-border: rgba(47,128,255,.28);

      /* ===== PATH BACKGROUND IMAGE (ubah sesuai file kamu) ===== */
      --bg-img: url("assets/images/BgPLN.jpg");

      /* ====== KONTROL PANJANG SEARCH ====== */
      --search-width: 200px;         /* lebar normal */
      --search-width-focus: 250px;   /* lebar saat fokus / ada teks */
      --search-shift-focus: 3px;     /* geser ke kiri saat fokus (memanjang ke kiri) */
    }

    *{ box-sizing:border-box; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 0; margin: 0;

      /* background seperti contoh: gambar + overlay biru */
      background-color: var(--bg);
      background-image:
        linear-gradient(90deg,
          rgba(0,151,167,.88) 0%,
          rgba(0,151,167,.78) 55%,
          rgba(0,151,167,.62) 100%
        ),
        var(--bg-img);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;

      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ====== Judul Beranda + garis bawah ====== */
    h2{
      margin: 0;
      color: #ffffff;
      text-shadow: 0 2px 10px rgba(0,0,0,0.25);
      border-bottom: 3px solid rgba(255,255,255,0.65);
      padding-bottom: 10px;

      display: inline-block;
      width: fit-content;

      /* tambah panjang garis ke kanan (kalau mau) */
      padding-right:450px;
    }

    /* ===== WELCOME BANNER (sesuai gambar) ===== */
    .welcome-banner{
      position: relative;
      margin-top: 10px;
      margin-bottom: 12px;

      border-radius: 18px;
      overflow: hidden;
      padding: 22px 26px;

      background: linear-gradient(90deg,
        #00132b 0%,
        #002a59 55%,
        #0077b6 100%
      );

      box-shadow: 0 12px 28px rgba(0,0,0,.18);
      min-height: 132px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .welcome-text{
      position: relative;
      z-index: 2;
      min-width: 0;
      color: #fff;
    }
    .welcome-title{
      margin: 0;
      font-size: 2rem;
      font-weight: 900;
      letter-spacing: .2px;
      line-height: 1.15;
      color: #fff;
    }
    .welcome-subtitle{
      margin: 10px 0 0 0;
      font-size: 1rem;
      font-weight: 650;
      color: rgba(255,255,255,.82);
    }

    /* strip bawah + wave kiri */
    .welcome-wave{
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 42%;
      width: 100%;
      z-index: 1;
      pointer-events: none;
    }

    /* ilustrasi user kanan */
    .welcome-art{
      position: absolute;
      right: -28px;
      top: 50%;
      transform: translateY(-50%);
      width: 380px;
      height: 170px;
      z-index: 2;
      pointer-events: none;
      opacity: .92;
    }

    @media (max-width: 900px){
      .welcome-title{ font-size: 1.45rem; }
      .welcome-subtitle{ font-size: .95rem; }
      .welcome-art{ width: 300px; height: 150px; right: -40px; }
    }
    @media (max-width: 700px){
      .welcome-banner{ padding: 18px 16px; }
      .welcome-art{ display:none; }
    }

    /* ===== Layout ===== */
    .layout{
      display:flex;
      min-height:100vh;
      position: relative;
      z-index: 1;
    }

    .main{
      flex:1;
      padding: 20px;
      overflow-x: hidden;
    }

    /* ===== Topbar ===== */
    .topbar{
      display:flex;
      align-items:flex-end;
      gap:12px;
      margin-bottom: 8px;

      position: relative;
      z-index: 50;
    }

    .sidebar-toggle{
      display:none;
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }

    /* biar judul tidak “ngambil space” terlalu besar */
    .topbar h2{
      flex: 0 0 auto; /* jangan stretch */
    }

    /* ===== Search + Profile ===== */
    .top-actions{
      display:flex;
      align-items:center;
      gap: 7px;
      margin-left:auto;
      flex: 0 0 auto;

      position: relative;
      z-index: 60;
    }

    .search-pill{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 6px 18px rgba(0,0,0,.12);

      min-width: 260px;
      max-width: 420px;

      width: var(--search-width);
      transform-origin: right center;
      transition: width .25s ease, transform .25s ease, box-shadow .25s ease;

      position: relative;
      z-index: 70;
      pointer-events: auto;
    }

    .search-pill iconify-icon{
      font-size: 20px;
      color: rgba(17,24,39,.65);
      pointer-events: none;
    }

    .search-pill input{
      border: none !important;
      outline: none !important;
      background: transparent !important;
      padding: 0 !important;
      min-height: 0 !important;
      width: 100%;
      font-size: .95rem;
      font-weight: 650;
      color: #111827;
      pointer-events: auto;
    }

    /* saat fokus atau ada teks: melebar + geser ke kiri */
    .search-pill:focus-within,
    .search-pill.has-text{
      width: var(--search-width-focus);
      transform: translateX(calc(-1 * var(--search-shift-focus)));
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }

    .profile-btn{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.95);
      box-shadow: 0 6px 18px rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .08s ease;
      z-index: 70;
    }
    .profile-btn:hover{ transform: translateY(-1px); }
    .profile-btn iconify-icon{
      font-size: 22px;
      color: rgba(17,24,39,.70);
      pointer-events: none;
    }

    @media (max-width: 900px){
      .search-pill{ width: 220px; min-width: 220px; }
      .search-pill:focus-within,
      .search-pill.has-text{
        width: 320px;
        transform: translateX(-28px);
      }
    }
    @media (max-width: 680px){
      .search-pill{ display:none; }
    }

    .overlay{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      z-index: 9998;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width: 270px;
      background: linear-gradient(180deg, var(--sb-bg1) 0%, var(--sb-bg2) 55%, var(--sb-bg3) 100%);
      color: var(--sb-text);
      padding: 18px 14px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(255,255,255,.06);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
    }
    .logo-pln{
      width: 190px;
      height: auto;
      object-fit: contain;
      border: none !important;
      border-radius: 0 !important;
      outline: none !important;
      box-shadow: none !important;
      cursor: default;
    }

    .sb-sep{
      height: 2px;
      width: 100%;
      margin: 12px 0 10px;
      background: rgba(47,128,255,.35);
      border-radius: 999px;
      opacity: .9;
    }

    .nav{ display:flex; flex-direction:column; gap: 8px; }

    .sidebar iconify-icon{
      font-size: 22px;
      color: var(--sb-accent);
      flex: 0 0 auto;
    }

    .nav-item{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;

      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--sb-text);

      cursor:pointer;
      font-weight: 750;
      font-size: 0.95rem;
      text-align:left;

      transition: background-color .15s, border-color .15s, transform .05s;
    }
    .nav-item:hover{ background: var(--sb-item); transform: translateY(-1px); }
    .nav-item.active{ background: var(--sb-active); border-color: var(--sb-border); }

    .nav-left{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .nav-left span{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav-collapse{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.06);
    }
    .nav-collapse:hover{ background: var(--sb-item2); }

    .nav-collapse .chevron{
      color: rgba(229,231,235,.9);
      font-size: 22px;
      transition: transform .18s ease;
    }
    #btnScripts.open .chevron{ transform: rotate(180deg); }

    .nav-sub{
      margin-top: 6px;
      margin-left: 12px;
      padding-left: 14px;
      position: relative;
      display:block;
    }
    .nav-sub::before{
      content:"";
      position:absolute;
      left: 4px;
      top: 4px;
      bottom: 4px;
      width: 2px;
      background: rgba(47,128,255,.35);
      border-radius: 999px;
    }
    .nav-sub.closed{ display:none; }

    .nav-sub-item{
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.92rem;
    }

    /* ===== Main cards ===== */
    #upload{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      background:#ffffffcc;
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
      margin-top: 12px;
      backdrop-filter: blur(4px);
    }
    #upload label{ font-weight:800; }

    input[type="file"], input[type="text"], select, button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #ccc;
      background:#fff;
      min-height: 40px;
    }
    input[type="text"], select{ width:100%; }

    /* override khusus untuk select freeze di bar upload agar tidak 100% */
    #upload #freezeColumnSelect{
      width: 260px;
    }
    @media (max-width: 700px){
      #upload #freezeColumnSelect{ width: 100%; }
    }

    button{
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 800;
      transition: background-color .2s, transform .1s;
      white-space: nowrap;
    }
    button:hover{ background: var(--primary2); transform: translateY(-1px); }
    button:disabled{ background:#ccc; cursor:not-allowed; transform:none; }
    #reloadBtn{ background: var(--success); }
    #reloadBtn:hover{ background: #16a34a; }

    #app-container{
      background: var(--card);
      padding: 18px;
      margin-top: 10px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    #controls-group{
      display:grid;
      gap: 12px;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px dashed #ddd;
      grid-template-columns: repeat(16, 1fr);
      align-items: stretch;
    }

    .control-card{
      background: #fafafa;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-height: 130px;
    }
    .control-card label{ font-weight: 800; }
    .control-card .small-note{
      font-size: 0.78rem;
      color: var(--muted);
      margin: 0;
      line-height: 1.25;
    }

    .span-16{ grid-column: span 16; }
    .span-8{ grid-column: span 8; }
    .span-7{ grid-column: span 7; }
    .span-3{ grid-column: span 3; }

    @media (max-width: 1100px){
      #controls-group{ grid-template-columns: repeat(16, 1fr); }
      .span-7{ grid-column: span 16; }
      .span-3{ grid-column: span 8; }
    }
    @media (max-width: 640px){
      #controls-group{ grid-template-columns: repeat(8, 1fr); }
      .span-7, .span-3{ grid-column: span 8; }
    }

    .folder-inline {
      display: grid;
      grid-template-columns: 1fr 260px 190px;
      gap: 10px;
      align-items: end;
    }
    .folder-inline .full { grid-column: 1 / -1; }
    @media (max-width: 900px) { .folder-inline { grid-template-columns: 1fr; } }

    .status-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .status-badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width: 90px;
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      font-weight: 900;
      color:#fff;
      border:1px solid rgba(0,0,0,0.08);
    }
    .status-badge.true{ background: var(--success); }
    .status-badge.false{ background: var(--danger); }
    .status-badge.na{ background: var(--gray); }

    #statusSummary{
      color: var(--muted);
      font-size: 0.85rem;
      line-height: 1.25;
    }

    #pagination-container{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      padding-top: 10px;
      margin-top: 10px;
      border-top: 1px solid #eee;
    }
    #pagination-info{
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 10px;
      background:#fafafa;
      border:1px solid var(--border);
      flex: 1 1 260px;
      text-align:center;
    }

    #table-container{
      width:100%;
      overflow-x:auto;
      max-height:70vh;
      overflow-y:auto;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.08);
      margin-top: 14px;
      border:1px solid var(--border);
      background:#fff;
      scrollbar-width: thin;
      scrollbar-color: #888 #f1f1f1;
    }

    table{
      border-collapse: collapse;
      min-width: 100%;
      background: white;
      font-size: 0.75rem;
      table-layout: auto;
    }
    table.wide-table { min-width: max-content; }

    th, td{
      border: 1px solid #e0e0e0;
      padding: 8px 10px;
      white-space: nowrap;
      vertical-align: middle;
      min-width: 100px;
    }

    th{
      background: #111827;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
      font-weight: 900;
      user-select: none;
      height: 40px;
      min-width: 100px;
    }
    th:not(:last-child):hover{ background:#0b1220; cursor:pointer; }

    #filterRow{
      background: #f1f1f1;
      z-index: 9;
      position: sticky;
      top: 40px;
    }
    #filterRow select{
      width: 100%;
      padding: 6px;
      border:1px solid #ccc;
      border-radius: 8px;
      font-size: 0.72rem;
      cursor:pointer;
    }
    #filterRow td{ padding: 6px 10px; }

    img.thumb{
      width: 76px; height: 76px;
      object-fit: cover;
      border: 2px solid #ccc;
      border-radius: 10px;
      cursor: pointer;
      transition: transform .1s, border-color .1s;
    }
    img.thumb:hover{ transform: scale(1.05); border-color: var(--primary); }
    @media (max-width: 640px){ img.thumb{ width:64px; height:64px; } }

    .frozen{ box-shadow: 2px 0 5px rgba(0,0,0,0.18); }

    .row-status{
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 90px;
      border: 1px solid rgba(0,0,0,0.08);
      color: #fff;
      font-size: 0.75rem;
    }
    .row-status.true{ background: var(--success); }
    .row-status.false{ background: var(--danger); }
    .row-status.na{ background: var(--gray); }

    /* Dashboard */
    #dashboardContent{
      margin-top: 20px;
      padding: 10px 0 0 0;
      border-top: 1px solid #eee;
    }
    #dashboardContent h3{
      font-size: 1.4rem;
      color: #333;
      margin: 0 0 14px 0;
    }
    #dashboard-controls{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      align-items: end;
      background:#fafafa;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }
    #dashboard-controls p{ margin:0; color: var(--muted); font-size: 0.9rem; grid-column: span 12; }
    #dashboard-controls label{ font-weight: 900; grid-column: span 12; }
    #dashboardColumnInput{ grid-column: span 9; width:100%; }
    #dashboard-controls button{ grid-column: span 3; width:100%; }
    @media (max-width: 900px){
      #dashboardColumnInput{ grid-column: span 12; }
      #dashboard-controls button{ grid-column: span 12; }
    }
    .dashboard-card{
      background: #fcfcfc;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .dashboard-card h4{
      color: var(--primary);
      font-size: 1.1rem;
      margin: 0 0 12px 0;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 6px;
    }
    .breakdown-table{
      width: 100%;
      font-size: 0.9rem;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
    }
    .breakdown-table th{
      background: var(--primary);
      color: white;
      position: static;
      z-index: auto;
      text-align: left;
      padding: 10px;
    }
    .breakdown-table td{ padding: 8px 10px; background: white; }
    .breakdown-table tbody tr:nth-child(even) td{ background: #f9f9f9; }

    /* Popup */
    #popup{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: pointer;
      padding: 16px;
    }
    #popup img{
      max-width: 95vw;
      max-height: 95vh;
      width: auto;
      height: auto;
      object-fit: contain;
      border: 5px solid white;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255,255,255,0.45);
    }
    #closeBtn{
      position:absolute;
      top: 14px;
      right: 16px;
      font-size: 40px;
      color: white;
      cursor: pointer;
      font-weight: 200;
      line-height: 1;
      padding: 6px 14px;
      border-radius: 999px;
      transition: background-color .2s;
    }
    #closeBtn:hover{ background-color: rgba(255,255,255,0.2); }

    /* Runner modal */
    .run-modal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.65);
      z-index: 10000;
      padding: 16px;
    }
    .run-card{
      width: min(980px, 96vw);
      max-height: 90vh;
      background: #0b1220;
      color: #e5e7eb;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .run-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .run-title{ font-weight: 900; font-size: .95rem; }
    .icon-btn{
      border:none;
      background: transparent;
      color: #fff;
      cursor:pointer;
      font-size: 22px;
      line-height: 1;
      padding: 6px 10px;
      border-radius: 10px;
    }
    .icon-btn:hover{ background: rgba(255,255,255,.08); }
    .run-body{
      padding: 12px 14px;
      overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: .85rem;
      white-space: pre-wrap;
    }
    .run-meta{
      padding: 10px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      background: rgba(255,255,255,.03);
    }
    .pill{
      border:1px solid rgba(255,255,255,.18);
      padding:4px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:.75rem;
      opacity:.9;
    }
    .pill.ok{ border-color: rgba(34,197,94,.6); }
    .pill.err{ border-color: rgba(239,68,68,.6); }

    /* Mobile */
    @media (max-width: 900px){
      .sidebar{
        position: fixed;
        left: -290px;
        z-index: 9999;
        transition: left .2s ease;
      }
      .sidebar.open{ left: 0; }
      .overlay.show{ display:block; }
      .sidebar-toggle{ display:inline-flex; }
      #table-container { max-height: 60vh; }
    }
  </style>
</head>

<body>
  <div id="overlay" class="overlay" onclick="toggleSidebar(false)"></div>

  <div class="layout">
    <!-- ===== SIDEBAR ===== -->
    <aside id="sidebar" class="sidebar">
      <div class="brand">
        <img src="assets/images/Logo_PLN.svg" alt="Logo PLN" class="logo-pln">
      </div>

      <div class="sb-sep"></div>

      <div class="nav">
        <button class="nav-item active" id="nav-viewer" onclick="goTab('viewerTab')">
          <span class="nav-left">
            <iconify-icon icon="mdi:database"></iconify-icon>
            <span>Beranda</span>
          </span>
        </button>

        <button class="nav-item" id="nav-dashboard" onclick="goTab('dashboardTab')">
          <span class="nav-left">
            <iconify-icon icon="mdi:view-dashboard"></iconify-icon>
            <span>Dashboard Rekapitulasi</span>
          </span>
        </button>

        <button class="nav-item nav-collapse" id="btnScripts" onclick="toggleScripts()">
          <span class="nav-left">
            <iconify-icon icon="mdi:language-python"></iconify-icon>
            <span>Script Python</span>
          </span>
          <iconify-icon class="chevron" icon="mdi:chevron-down"></iconify-icon>
        </button>

        <div id="scriptsMenu" class="nav-sub closed">
          <button class="nav-item nav-sub-item" onclick="runTool('data_cust_new')">
            <span class="nav-left">
              <iconify-icon icon="mdi:account-group"></iconify-icon>
              <span>Data Customer</span>
            </span>
          </button>

          <button class="nav-item nav-sub-item" onclick="runTool('split_idpel')">
            <span class="nav-left">
              <iconify-icon icon="mdi:card-text-outline"></iconify-icon>
              <span>Split IDPEL</span>
            </span>
          </button>

          <button class="nav-item nav-sub-item" onclick="runTool('download_foto')">
            <span class="nav-left">
              <iconify-icon icon="mdi:download"></iconify-icon>
              <span>Download Foto ACMT</span>
            </span>
          </button>

          <button class="nav-item nav-sub-item" onclick="runTool('verifikasi_kwh')">
            <span class="nav-left">
              <iconify-icon icon="mdi:checkbox-marked-outline"></iconify-icon>
              <span>Verifikasi kWh</span>
            </span>
          </button>

          <button class="nav-item nav-sub-item" onclick="runTool('filter_output_scan')">
            <span class="nav-left">
              <iconify-icon icon="mdi:filter-variant"></iconify-icon>
              <span>Filter Output Scan</span>
            </span>
          </button>
        </div>
      </div>
    </aside>

    <!-- ===== MAIN ===== -->
    <main class="main">
      <div class="topbar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>
        <h2>Beranda</h2>

        <!-- Search + Profile -->
        <div class="top-actions">
          <div class="search-pill" title="Cari IDPEL (Global)">
            <iconify-icon icon="mdi:magnify"></iconify-icon>
            <input
              type="text"
              id="idpelSearch"
              placeholder="Cari"
              aria-label="Cari IDPEL"
            />
          </div>

          <button class="profile-btn" type="button" onclick="openProfile()" title="Profile">
            <iconify-icon icon="mdi:account-circle-outline"></iconify-icon>
          </button>
        </div>
      </div>

      <!-- ===== WELCOME BANNER ===== -->
      <div class="welcome-banner">
        <div class="welcome-text">
          <h1 class="welcome-title">Selamat Datang, Admin!</h1>
          <p class="welcome-subtitle">Selamat Datang, Admin!</p>
        </div>

        <!-- ilustrasi user kanan -->
        <svg class="welcome-art" viewBox="0 0 520 260" aria-hidden="true">
          <circle cx="350" cy="55" r="42" fill="rgba(255,255,255,.85)"></circle>
          <path
            d="M250,105
               C295,75 320,98 348,118
               C378,140 412,144 450,120
               C494,92 536,126 514,168
               C482,232 392,252 312,234
               C244,218 188,178 210,142
               C224,118 236,112 250,105 Z"
            fill="rgba(255,255,255,.82)"
          ></path>
        </svg>
      </div>

      <div id="upload">
        <label for="fileInput">Unggah File Excel (.xlsx/.xls):</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls" />

        <!-- PINDAH FITUR FREEZE KE SINI -->
        <label for="freezeColumnSelect">Bekukan Hingga Kolom:</label>
        <select id="freezeColumnSelect" title="Bekukan kolom sampai pilihan ini"></select>
        <button onclick="applyFreeze()">Terapkan Freeze</button>
      </div>

      <div id="app-container">
        <!-- TAB: VIEWER -->
        <div id="viewerTab" class="tab-content">
          <h3 style="margin: 6px 0 0 0; color:#555;">Tabel Data Interaktif</h3>

          <div id="controls-group">
            <div class="control-card span-7">
              <label for="folderInput">Folder Foto (hanya nama folder):</label>

              <div class="folder-inline">
                <div>
                  <input type="text" id="folderInput"
                         placeholder="downloaded_foto_meter"
                         value="downloaded_foto_meter">
                  <p class="small-note" style="margin:6px 0 0 0;">
                    <b>Pola otomatis:</b> {IDPEL}_{TAHUNBULAN}_{INDEX}.jpg
                  </p>
                </div>

                <div>
                  <label style="font-weight:800; font-size:0.9rem;">Template Gambar Pagar (opsional):</label>
                  <input type="file" id="pagarTemplateInput" accept="image/*" />
                </div>

                <div>
                  <button onclick="updateImageFolders()">Terapkan Folder Foto</button>
                </div>

                <div id="pagarTemplateInfo" class="small-note full">Template pagar: belum diunggah</div>
              </div>
            </div>

            <!-- KARTU FREEZE DIHAPUS (SUDAH PINDAH KE BAR ATAS) -->

            <div class="control-card span-3">
              <label>Status Validasi (OCR):</label>
              <div class="status-row">
                <span id="statusBadge" class="status-badge na">N/A</span>
                <select id="statusFilterSelect" onchange="filterTable()" disabled style="flex:1;">
                  <option value="">Semua</option>
                  <option value="true">True</option>
                  <option value="false">False</option>
                </select>
              </div>
              <div id="statusSummary">Kolom OCR belum terdeteksi</div>
            </div>
          </div>

          <div id="pagination-container">
            <button id="prevBtn" onclick="changePage(-1)" disabled>← Sebelumnya</button>
            <span id="pagination-info">Data Belum Dimuat</span>
            <button id="nextBtn" onclick="changePage(1)" disabled>Berikutnya →</button>
          </div>

          <div id="table-container">
            <table id="dataTable"></table>
          </div>
        </div>

        <!-- TAB: DASHBOARD -->
        <div id="dashboardTab" class="tab-content" style="display:none;">
          <h3 style="margin: 6px 0 0 0; color:#555;">Rekapitulasi Kategori Data</h3>

          <div id="dashboard-controls">
            <label for="dashboardColumnInput">Tambahkan Kolom Rekapitulasi (Pisahkan koma):</label>
            <p>Kolom Otomatis: <strong>UNITAP, UP, KDBACA</strong>. Tambahkan kolom lain di bawah ini.</p>
            <input type="text" id="dashboardColumnInput" placeholder="Contoh: KDCAT, JNSBANGUNAN">
            <button onclick="renderDashboard()">Hitung Rekapitulasi</button>
          </div>

          <div id="dashboardContent">
            <p style="text-align:center; padding:50px; color:#666;">Silakan unggah data Excel dan klik "Hitung Rekapitulasi" untuk melihat ringkasan data.</p>
          </div>
        </div>
      </div>

      <!-- Popup image -->
      <div id="popup" onclick="closePopup(event)">
        <span id="closeBtn">✕</span>
        <img id="popupImg" src="" alt="Gambar Popup" />
      </div>

      <!-- Modal runner -->
      <div id="runModal" class="run-modal" onclick="closeRunModal(event)">
        <div class="run-card">
          <div class="run-head">
            <div class="run-title" id="runTitle">Menjalankan...</div>
            <button class="icon-btn" onclick="closeRunModal()">✕</button>
          </div>
          <div class="run-body" id="runOutput">...</div>
          <div class="run-meta">
            <span id="runCode" class="pill">RC: -</span>
            <span style="opacity:.75; font-size:.8rem;">Jika tombol run error: pastikan backend sudah jalan.</span>
          </div>
        </div>
      </div>

      <script>
        // ===== URL base =====
        const currentPath = window.location.pathname;
        const baseFolder = currentPath.split('/').slice(0, -1).join('/') || '/';
        const baseUrl = window.location.origin + baseFolder;

        // ===== Profile action =====
        function openProfile(){
          alert("Profile diklik. (Bisa dibuat dropdown/modal.)");
        }

        // ===== Sidebar toggle (mobile) =====
        function toggleSidebar(force){
          const sb = document.getElementById('sidebar');
          const ov = document.getElementById('overlay');
          const isOpen = sb.classList.contains('open');
          const next = (typeof force === 'boolean') ? force : !isOpen;

          if(next){
            sb.classList.add('open');
            ov.classList.add('show');
          }else{
            sb.classList.remove('open');
            ov.classList.remove('show');
          }
        }

        function setSidebarActive(tabId){
          const viewer = document.getElementById('nav-viewer');
          const dash = document.getElementById('nav-dashboard');
          if(!viewer || !dash) return;

          viewer.classList.remove('active');
          dash.classList.remove('active');

          if(tabId === 'dashboardTab') dash.classList.add('active');
          else viewer.classList.add('active');
        }

        function goTab(tabId){
          showTab(tabId);
          toggleSidebar(false);
        }

        // ===== Collapsible Script Python =====
        function toggleScripts(force){
          const menu = document.getElementById('scriptsMenu');
          const btn  = document.getElementById('btnScripts');
          if(!menu || !btn) return;

          const isClosed = menu.classList.contains('closed');
          const open = (typeof force === 'boolean') ? force : isClosed;

          if(open){
            menu.classList.remove('closed');
            btn.classList.add('open');
          }else{
            menu.classList.add('closed');
            btn.classList.remove('open');
          }
        }

        function showTab(tabId){
          document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
          document.getElementById(tabId).style.display = 'block';
          setSidebarActive(tabId);
          if(tabId === 'dashboardTab' && currentRawData.length > 1) renderDashboard();
        }

        function reloadApp(){ window.location.reload(); }

        // ===== State =====
        const table = document.getElementById("dataTable");
        const tableContainer = document.getElementById("table-container");

        let currentRawData = [];
        let filteredAndSortedData = [];
        let sortDirection = {};
        let columnFilters = {};
        let rowsPerPage = 50;
        let currentPage = 1;

        let ocrColIndex = -1;
        let refColIndex = -1;
        let idpelColIndex = -1;

        // Foto folder
        let imageFolder = "downloaded_foto_meter";

        // Template pagar hash
        let pagarTemplateHash = null;

        // Stan status store for filter
        let stanStatusFilters = {};
        let stanStatusData = {};
        let hasFilterResults = true;

        // ===== Search animation + filter trigger =====
        function initTopSearch(){
          const input = document.getElementById('idpelSearch');
          const pill  = document.querySelector('.search-pill');
          if(!input || !pill) return;

          const sync = () => {
            pill.classList.toggle('has-text', input.value.trim().length > 0);
          };

          input.addEventListener('input', () => {
            sync();
            filterTable();
          });

          sync();
        }

        // ===== Helpers =====
        function normalizeDigits(v){ return String(v ?? '').replace(/\D/g, ''); }

        function findOcrColumnIndex(headers){
          const upper = headers.map(h => String(h).toUpperCase());
          return upper.findIndex(h => h.includes('OCR'));
        }
        function findReferenceColumnIndex(headers, ocrIdx){
          const upper = headers.map(h => String(h).toUpperCase());
          let idx = upper.indexOf('KDBACA');
          if (idx !== -1 && idx !== ocrIdx) return idx;
          idx = upper.findIndex(h => h.includes('BACA') && !h.includes('OCR'));
          if (idx !== -1 && idx !== ocrIdx) return idx;
          return -1;
        }
        function findIdpelColumnIndex(headers){
          const upper = headers.map(h => String(h).toUpperCase());
          return upper.findIndex(h => h.includes('IDPEL'));
        }

        // ===== OCR check =====
        function checkOcrReadable(ocrValue){
          if(!ocrValue) return false;
          const s = String(ocrValue).trim().toLowerCase();
          if(s.includes('tidak terbaca')) return false;
          if(s.startsWith('stand:')){
            const n = s.split(':')[1]?.trim() || '';
            return /\d+/.test(n);
          }
          return /\d/.test(s);
        }

        function computeRowStatus(row){
          if(ocrColIndex === -1) return null;
          const ocrRaw = String(row[ocrColIndex] ?? '').trim();
          const ocrDigits = normalizeDigits(ocrRaw);
          if(!ocrDigits) return false;

          if(refColIndex !== -1){
            const refDigits = normalizeDigits(row[refColIndex]);
            if(refDigits && ocrDigits !== refDigits) return false;
          }
          return true;
        }

        // ===== YearMonth extraction =====
        function getCurrentYearMonth(){
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth()+1).padStart(2,'0');
          return `${year}${month}`;
        }

        function extractYearMonthFromExcel(rowData){
          if(!currentRawData.length) return getCurrentYearMonth();
          const headers = currentRawData[0];

          const dateHeaders = ['BLTH','BULAN','PERIODE','MONTH','TGL','TANGGAL','DATE','PERIOD'];
          for(let i=0;i<headers.length;i++){
            const colName = String(headers[i]).toUpperCase();
            if(dateHeaders.some(k => colName.includes(k))){
              const value = rowData[i];
              if(!value) continue;
              const strVal = String(value);

              if(/^\d{6}$/.test(strVal)) return strVal;
              if(/^\d{4}-\d{2}-\d{2}$/.test(strVal)) return strVal.replace(/-/g,'').substring(0,6);
              if(/^\d{2}\/\d{2}\/\d{4}$/.test(strVal)){
                const parts = strVal.split('/');
                return parts[2] + parts[1];
              }
              const nums = strVal.match(/\d+/g);
              if(nums){
                for(const num of nums){
                  if(num.length === 6) return num;
                }
              }
            }
          }

          for(let i=0;i<rowData.length;i++){
            const v = String(rowData[i] || '');
            if(/^\d{6}$/.test(v)) return v;
          }

          return getCurrentYearMonth();
        }

        // ===== Image URL =====
        function generateImageUrl(idpel, folderIndex, rowData){
          if(!idpel) return null;
          const yearMonth = extractYearMonthFromExcel(rowData);
          const fotoIndex = folderIndex + 1;
          const fileName = `${idpel}_${yearMonth}_${fotoIndex}.jpg`;
          return `${baseUrl}/${imageFolder}/${fileName}`;
        }

        async function checkImageExists(url){
          try{
            const res = await fetch(url, { method:'HEAD' });
            return res.ok;
          }catch{ return false; }
        }

        async function findAlternativeImage(idpel, folderIndex, rowData){
          const yearMonth = extractYearMonthFromExcel(rowData);
          const fotoIndex = folderIndex + 1;

          const patterns = [
            `${idpel}_${yearMonth}_${fotoIndex}.jpg`,
            `${idpel}_${fotoIndex}.jpg`,
            fotoIndex === 1 ? `${idpel}.jpg` : null,

            `${idpel}_${yearMonth}_${fotoIndex}.png`,
            `${idpel}_${fotoIndex}.png`,
            fotoIndex === 1 ? `${idpel}.png` : null,

            `${idpel}_${yearMonth}_${fotoIndex}.jpeg`,
            `${idpel}_${fotoIndex}.jpeg`,
            fotoIndex === 1 ? `${idpel}.jpeg` : null
          ].filter(Boolean);

          for(const p of patterns){
            const testUrl = `${baseUrl}/${imageFolder}/${p}`;
            if(await checkImageExists(testUrl)) return testUrl;
          }
          return null;
        }

        async function loadImageForIdpel(imgEl, idpel, folderIndex, rowData){
          const mainUrl = generateImageUrl(idpel, folderIndex, rowData);
          if(mainUrl && await checkImageExists(mainUrl)){
            imgEl.src = mainUrl;
            return true;
          }
          const alt = await findAlternativeImage(idpel, folderIndex, rowData);
          if(alt){
            imgEl.src = alt;
            return true;
          }
          return false;
        }

        // ===== Template pagar detection (aHash) =====
        function aHashFromImage(imgEl, size=8){
          const canvas = document.createElement('canvas');
          canvas.width = size; canvas.height = size;
          const ctx = canvas.getContext('2d', { willReadFrequently:true });
          ctx.drawImage(imgEl, 0, 0, size, size);
          const data = ctx.getImageData(0,0,size,size).data;

          const grays = [];
          for(let i=0;i<data.length;i+=4){
            const r=data[i], g=data[i+1], b=data[i+2];
            grays.push(0.2126*r+0.7152*g+0.0722*b);
          }
          const avg = grays.reduce((a,b)=>a+b,0)/grays.length;

          let hash = '';
          for(const v of grays) hash += (v > avg ? '1':'0');
          return hash;
        }
        function hamming(a,b){
          if(!a || !b || a.length !== b.length) return 999;
          let d=0;
          for(let i=0;i<a.length;i++) if(a[i] !== b[i]) d++;
          return d;
        }
        function isPagarImage(imgEl){
          if(!pagarTemplateHash) return false;
          try{
            const h = aHashFromImage(imgEl, 8);
            return hamming(h, pagarTemplateHash) <= 10;
          }catch{ return false; }
        }

        // ===== Status UI =====
        function setupStatusControls(){
          const badge = document.getElementById('statusBadge');
          const sel = document.getElementById('statusFilterSelect');
          const summary = document.getElementById('statusSummary');

          if(ocrColIndex === -1){
            sel.disabled = true;
            badge.className = 'status-badge na';
            badge.textContent = 'N/A';
            summary.textContent = 'Kolom OCR tidak ditemukan (header harus mengandung "OCR")';
            return;
          }
          sel.disabled = false;
          updateStatusUI();
        }

        function updateStatusUI(){
          const badge = document.getElementById('statusBadge');
          const summary = document.getElementById('statusSummary');
          if(!badge || !summary) return;

          if(currentRawData.length <= 1 || ocrColIndex === -1){
            badge.className = 'status-badge na';
            badge.textContent = 'N/A';
            summary.textContent = 'Kolom OCR belum terdeteksi';
            return;
          }

          let t=0,f=0,na=0;
          filteredAndSortedData.forEach(row=>{
            const st = computeRowStatus(row);
            if(st === true) t++;
            else if(st === false) f++;
            else na++;
          });

          if(f>0){ badge.className='status-badge false'; badge.textContent='FALSE'; }
          else if(t>0){ badge.className='status-badge true'; badge.textContent='TRUE'; }
          else { badge.className='status-badge na'; badge.textContent='N/A'; }

          const ocrName = currentRawData[0]?.[ocrColIndex] ?? 'OCR';
          const refName = (refColIndex !== -1) ? (currentRawData[0]?.[refColIndex] ?? '') : '';
          summary.textContent =
            `Kolom OCR: ${ocrName}${refName?` | Pembanding: ${refName}`:''} | Template pagar: ${pagarTemplateHash?'ADA':'BELUM'} | True: ${t} | False: ${f}${na?` | N/A: ${na}`:''}`;
        }

        // ===== File input: template pagar =====
        document.getElementById('pagarTemplateInput').addEventListener('change', (e)=>{
          const file = e.target.files?.[0];
          const info = document.getElementById('pagarTemplateInfo');
          if(!file){
            pagarTemplateHash = null;
            info.textContent = 'Template pagar: belum diunggah';
            updateStatusUI();
            return;
          }

          const reader = new FileReader();
          reader.onload = (evt)=>{
            const img = new Image();
            img.onload = ()=>{
              try{
                pagarTemplateHash = aHashFromImage(img, 8);
                info.textContent = `Template pagar: OK (${file.name})`;
                updateStatusUI();
                if(currentRawData.length > 1) renderPaginatedTable();
              }catch(err){
                pagarTemplateHash = null;
                info.textContent = 'Template pagar: gagal dibaca';
                updateStatusUI();
              }
            };
            img.src = evt.target.result;
          };
          reader.readAsDataURL(file);
        });

        // ===== Upload excel =====
        document.getElementById("fileInput").addEventListener("change", (e)=>{
          const file = e.target.files?.[0];
          if(!file) return;

          table.innerHTML = "";
          document.getElementById("freezeColumnSelect").innerHTML = "";

          currentRawData = [];
          filteredAndSortedData = [];
          sortDirection = {};
          columnFilters = {};
          currentPage = 1;

          stanStatusFilters = {};
          stanStatusData = {};
          hasFilterResults = true;

          document.getElementById("idpelSearch").value = "";
          const pill = document.querySelector('.search-pill');
          if(pill) pill.classList.remove('has-text');

          document.getElementById("pagination-info").textContent = "Memproses Data...";

          document.getElementById('dashboardContent').innerHTML =
            '<p style="text-align:center; padding:50px; color:#666;">Data Excel berhasil diunggah. Klik "Hitung Rekapitulasi" untuk melihat ringkasan data.</p>';

          const reader = new FileReader();
          reader.onload = (evt)=>{
            try{
              const data = new Uint8Array(evt.target.result);
              const wb = XLSX.read(data, {type:"array"});
              const sheet = wb.Sheets[wb.SheetNames[0]];
              const rows = XLSX.utils.sheet_to_json(sheet, {header:1});

              if(!rows.length) throw new Error("File Excel kosong.");
              currentRawData = rows;
              filteredAndSortedData = rows.slice(1);

              const headers = currentRawData[0] || [];
              ocrColIndex = findOcrColumnIndex(headers);
              refColIndex = findReferenceColumnIndex(headers, ocrColIndex);
              idpelColIndex = findIdpelColumnIndex(headers);

              filterTable();
              setupStatusControls();
              showTab('viewerTab');
            }catch(err){
              alert("Gagal memproses file. Pastikan formatnya benar (.xlsx atau .xls).");
            }
          };
          reader.readAsArrayBuffer(file);
        });

        function updateImageFolders(){
          const input = document.getElementById("folderInput").value.trim();
          imageFolder = input || "downloaded_foto_meter";

          stanStatusFilters = {};
          stanStatusData = {};
          hasFilterResults = true;

          if(currentRawData.length > 1){
            currentPage = 1;
            filterTable();
          }else{
            alert(`Folder foto disimpan: ${imageFolder}. Unggah Excel untuk melihat tabel.`);
          }
        }

        // ===== Filter =====
        function getUniqueColumnValues(columnIndex){
          if(currentRawData.length <= 1) return [];
          const values = new Set();
          currentRawData.slice(1).forEach(row=>{
            const v = String(row[columnIndex] ?? '').trim();
            if(v) values.add(v.toUpperCase());
          });
          return Array.from(values).sort();
        }

        function updateColumnFilter(columnIndex, value){
          const v = value.trim();
          if(v) columnFilters[columnIndex] = v;
          else delete columnFilters[columnIndex];
          currentPage = 1;
          filterTable();
        }

        function updateStanStatusFilter(imageIndex, value){
          const v = value.trim();
          if(v) stanStatusFilters[imageIndex] = v;
          else delete stanStatusFilters[imageIndex];
          currentPage = 1;
          filterTable();
        }

        function filterTable(){
          const globalSearch = document.getElementById("idpelSearch").value.trim().toUpperCase();

          if(currentRawData.length === 0){
            filteredAndSortedData = [];
            renderPaginatedTable();
            updateStatusUI();
            return;
          }

          const rawRows = currentRawData.slice(1);
          let filtered = [...rawRows];

          // column filters
          const activeColFilters = Object.keys(columnFilters);
          if(activeColFilters.length){
            filtered = filtered.filter(row=>{
              for(const k of activeColFilters){
                const idx = parseInt(k,10);
                const need = columnFilters[k];
                const rowVal = String(row[idx] ?? '').toUpperCase();
                if(rowVal !== need) return false;
              }
              return true;
            });
          }

          // global IDPEL search
          if(idpelColIndex !== -1 && globalSearch){
            filtered = filtered.filter(row=>{
              const v = String(row[idpelColIndex] ?? '').toUpperCase();
              return v.includes(globalSearch);
            });
          }

          // OCR status filter
          const statusSelectVal = document.getElementById('statusFilterSelect')?.value || '';
          if(statusSelectVal && ocrColIndex !== -1){
            filtered = filtered.filter(row=>{
              const st = computeRowStatus(row);
              return statusSelectVal === 'true' ? st === true : st === false;
            });
          }

          // Stan filters
          const activeStan = Object.keys(stanStatusFilters);
          if(activeStan.length && idpelColIndex !== -1){
            const temp = [];
            let found = false;

            for(const row of filtered){
              const idpel = String(row[idpelColIndex] ?? '');
              let ok = true;

              for(const key of activeStan){
                const imgIndex = parseInt(key,10);
                const required = stanStatusFilters[key];
                const stanKey = `${idpel}_${imgIndex}`;
                const actual = stanStatusData[stanKey];
                if(!actual || actual !== required){
                  ok = false; break;
                }
              }

              if(ok){ temp.push(row); found = true; }
            }

            if(found){
              filtered = temp;
              hasFilterResults = true;
            }else{
              hasFilterResults = false;
            }
          }else{
            hasFilterResults = true;
          }

          // sorting
          const sorted = [...filtered];
          const sortColIndex = Object.keys(sortDirection).length ? parseInt(Object.keys(sortDirection)[0],10) : -1;

          if(sortColIndex !== -1){
            const asc = sortDirection[sortColIndex] === 'asc';
            const first = sorted.map(r=>r[sortColIndex]).find(v=>v!==null && v!==undefined && v!=='');
            const isNum = first !== undefined && first !== null && !isNaN(Number(first));

            sorted.sort((A,B)=>{
              let a=A[sortColIndex], b=B[sortColIndex];
              if(a===null||a===undefined||a==='') a = asc ? Infinity : -Infinity;
              if(b===null||b===undefined||b==='') b = asc ? Infinity : -Infinity;

              if(isNum){
                a=Number(a); b=Number(b);
                return asc ? a-b : b-a;
              }else{
                a=String(a).toUpperCase(); b=String(b).toUpperCase();
                if(a<b) return asc?-1:1;
                if(a>b) return asc?1:-1;
                return 0;
              }
            });
          }

          filteredAndSortedData = sorted;
          currentPage = 1;
          renderPaginatedTable();
          updateStatusUI();
        }

        function sortTable(columnIndex){
          if(currentRawData.length<=1) return;
          const asc = sortDirection[columnIndex] !== 'asc';
          sortDirection = {};
          sortDirection[columnIndex] = asc ? 'asc' : 'desc';
          filterTable();
        }

        // ===== Pagination =====
        function updatePaginationControls(totalRows, totalPages){
          const info = document.getElementById("pagination-info");
          const prevBtn = document.getElementById("prevBtn");
          const nextBtn = document.getElementById("nextBtn");

          if(totalRows === 0){
            info.textContent = "Tidak ada data yang cocok (0 baris)";
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
          }

          const startRow = (currentPage-1)*rowsPerPage + 1;
          let endRow = startRow + rowsPerPage - 1;
          if(endRow > totalRows) endRow = totalRows;

          info.textContent = `Halaman ${currentPage} dari ${totalPages} | Baris ${startRow}-${endRow} dari ${totalRows}`;
          prevBtn.disabled = currentPage === 1;
          nextBtn.disabled = currentPage >= totalPages;
        }

        function changePage(direction){
          const totalRows = filteredAndSortedData.length;
          const totalPages = Math.ceil(totalRows/rowsPerPage) || 1;
          const newPage = currentPage + direction;
          if(newPage>=1 && newPage<=totalPages){
            currentPage = newPage;
            renderPaginatedTable();
            updateStatusUI();
          }
        }

        // ===== Freeze columns =====
        function createFreezeControls(allHeaders){
          const select = document.getElementById("freezeColumnSelect");
          select.innerHTML = "";

          const def = document.createElement('option');
          def.value = -1;
          def.textContent = "Jangan Bekukan";
          select.appendChild(def);

          allHeaders.forEach((h, idx)=>{
            const op = document.createElement('option');
            op.value = idx;
            op.textContent = `${h} (Kolom ${idx+1})`;
            select.appendChild(op);
          });
        }

        function applyFreeze(){
          const rows = table.querySelectorAll("tr");
          const select = document.getElementById("freezeColumnSelect");
          const freezeUntil = parseInt(select.value,10);

          table.querySelectorAll("th, td").forEach(cell=>{
            cell.style.position="";
            cell.style.left="";
            cell.style.zIndex="";
            cell.classList.remove("frozen");
          });

          if(!rows.length || freezeUntil < 0) return;

          let left = 0;
          for(let c=0;c<=freezeUntil;c++){
            const headerCell = rows[0].children[c];
            const w = headerCell ? headerCell.offsetWidth : 120;

            rows.forEach((r,rowIndex)=>{
              const cell = r.children[c];
              if(!cell) return;
              cell.style.position = "sticky";
              cell.style.left = left + "px";
              cell.style.zIndex = (rowIndex===0) ? 100 : (rowIndex===1 ? 98 : 99);
              cell.classList.add("frozen");
            });

            left += w;
          }

          tableContainer.scrollLeft = 1;
          setTimeout(()=>tableContainer.scrollLeft=0, 0);
        }

        // ===== Render table =====
        async function renderPaginatedTable(){
          const header = currentRawData.length ? currentRawData[0] : [];
          const totalRows = filteredAndSortedData.length;
          const totalPages = Math.ceil(totalRows/rowsPerPage) || 1;

          if(totalRows === 0 || header.length === 0){
            table.innerHTML = "<caption>Tidak ada data. Unggah Excel dulu.</caption>";
            updatePaginationControls(0,0);
            return;
          }

          if(currentPage > totalPages) currentPage = totalPages;
          if(currentPage < 1) currentPage = 1;

          const start = (currentPage-1)*rowsPerPage;
          const end = start + rowsPerPage;
          const pageData = filteredAndSortedData.slice(start, end);

          updatePaginationControls(totalRows, totalPages);
          table.innerHTML = "";

          const thead = document.createElement("thead");
          const hrow = document.createElement("tr");

          header.forEach((hText, idx)=>{
            const th = document.createElement("th");
            th.textContent = hText;
            th.onclick = ()=>sortTable(idx);
            if(sortDirection[idx]) th.textContent += (sortDirection[idx]==='asc'?' ▲':' ▼');
            hrow.appendChild(th);
          });

          for(let i=1;i<=3;i++){
            const thImg = document.createElement("th");
            thImg.textContent = `Gambar ${i}`;
            hrow.appendChild(thImg);

            const thSt = document.createElement("th");
            thSt.textContent = `STATUS Gambar ${i}`;
            hrow.appendChild(thSt);
          }

          thead.appendChild(hrow);

          const filterRow = document.createElement("tr");
          filterRow.id = "filterRow";

          header.forEach((_, i)=>{
            const td = document.createElement("td");
            const sel = document.createElement("select");

            const all = document.createElement("option");
            all.value = "";
            all.textContent = `Semua ${header[i]}`;
            sel.appendChild(all);

            getUniqueColumnValues(i).forEach(val=>{
              const op = document.createElement("option");
              op.value = val;
              op.textContent = val;
              sel.appendChild(op);
            });

            sel.value = columnFilters[i] || "";
            sel.onchange = (e)=>updateColumnFilter(i, e.target.value);
            td.appendChild(sel);
            filterRow.appendChild(td);
          });

          for(let i=0;i<3;i++){
            const tdImg = document.createElement("td");
            tdImg.innerHTML="&nbsp;";
            filterRow.appendChild(tdImg);

            const tdSt = document.createElement("td");
            const sel = document.createElement("select");

            [
              { value:"", text:"Semua Status" },
              { value:"valid", text:"✅ Valid" },
              { value:"invalid", text:"❌ Tidak Valid" },
              { value:"unknown", text:"❓ Tidak Diketahui" },
            ].forEach(opt=>{
              const op = document.createElement("option");
              op.value = opt.value;
              op.textContent = opt.text;
              if(opt.value === (stanStatusFilters[i] || "")) op.selected = true;
              sel.appendChild(op);
            });

            sel.onchange = (e)=>updateStanStatusFilter(i, e.target.value);
            tdSt.appendChild(sel);
            filterRow.appendChild(tdSt);
          }

          thead.appendChild(filterRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");

          if(pageData.length === 0){
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = header.length + 6;
            td.style.padding = "26px";
            td.style.textAlign = "center";
            td.style.color = "#666";
            td.style.fontStyle = "italic";

            td.innerHTML = !hasFilterResults
              ? `<strong>⚠️ Tidak ada data yang cocok dengan filter status stan.</strong><br><small>Coba pilih status lain atau "Semua Status".</small>`
              : `<strong>⚠️ Tidak ada data yang cocok dengan filter.</strong><br><small>Reset filter dropdown / hapus pencarian IDPEL.</small>`;

            tr.appendChild(td);
            tbody.appendChild(tr);
            table.appendChild(tbody);
            return;
          }

          for(const rowData of pageData){
            const tr = document.createElement("tr");

            for(let i=0;i<header.length;i++){
              const td = document.createElement("td");
              const v = rowData[i];
              td.textContent = (v===undefined||v===null||v==="") ? "-" : v;
              tr.appendChild(td);
            }

            const idpel = (idpelColIndex !== -1) ? String(rowData[idpelColIndex] ?? '') : '';
            const ocrVal = (ocrColIndex !== -1) ? rowData[ocrColIndex] : '';

            for(let imgIndex=0; imgIndex<3; imgIndex++){
              const tdImg = document.createElement("td");
              tdImg.className = "img-cell";

              const tdSt = document.createElement("td");
              tdSt.className = "row-status na";
              tdSt.textContent = "Loading...";
              tdSt.title = "Memeriksa gambar...";

              if(idpel){
                const img = document.createElement("img");
                img.className = "thumb";
                img.alt = `Gambar ${imgIndex+1} IDPEL ${idpel}`;
                img.onclick = ()=>{ if(img.src) openPopup(img.src); };

                const ok = await loadImageForIdpel(img, idpel, imgIndex, rowData);

                if(ok){
                  img.onload = ()=>{
                    const pagar = isPagarImage(img);
                    const readable = checkOcrReadable(ocrVal);

                    if(pagar){
                      tdSt.className = "row-status false";
                      tdSt.textContent = "Pagar";
                      tdSt.title = "Terdeteksi mirip template pagar";
                      stanStatusData[`${idpel}_${imgIndex}`] = "invalid";
                    }else if(readable){
                      tdSt.className = "row-status true";
                      tdSt.textContent = "Valid";
                      tdSt.title = "OCR terbaca (mengandung angka)";
                      stanStatusData[`${idpel}_${imgIndex}`] = "valid";
                    }else{
                      tdSt.className = "row-status false";
                      tdSt.textContent = "Tidak Valid";
                      tdSt.title = "OCR tidak terbaca angka";
                      stanStatusData[`${idpel}_${imgIndex}`] = "invalid";
                    }
                  };
                  img.onerror = ()=>{
                    tdSt.className = "row-status false";
                    tdSt.textContent = "Error";
                    tdSt.title = "Gagal memuat gambar";
                    stanStatusData[`${idpel}_${imgIndex}`] = "unknown";
                  };

                  tdImg.appendChild(img);
                }else{
                  tdImg.style.textAlign="center";
                  tdImg.style.color="#666";
                  tdImg.style.fontStyle="italic";
                  tdImg.textContent = "Tidak ditemukan";

                  tdSt.className = "row-status false";
                  tdSt.textContent = "Tidak Ada";
                  tdSt.title = "Gambar tidak ditemukan";
                  stanStatusData[`${idpel}_${imgIndex}`] = "unknown";
                }
              }else{
                tdImg.textContent = "-";
                tdImg.style.textAlign="center";
                tdSt.className = "row-status na";
                tdSt.textContent = "N/A";
                tdSt.title = "IDPEL kosong";
              }

              tr.appendChild(tdImg);
              tr.appendChild(tdSt);
            }

            tbody.appendChild(tr);
          }

          table.appendChild(tbody);

          const totalCols = header.length + 6;
          if(totalCols > 15) table.classList.add("wide-table");
          else table.classList.remove("wide-table");

          const allHeaders = [...header];
          for(let i=1;i<=3;i++){ allHeaders.push(`Gambar ${i}`, `STATUS Gambar ${i}`); }
          createFreezeControls(allHeaders);
          applyFreeze();
          tableContainer.scrollLeft = 0;
        }

        // ===== Dashboard =====
        function renderDashboard(){
          const defaultCols = ['UNITAP','UP','KDBACA'];
          const userInput = document.getElementById('dashboardColumnInput').value.trim();
          const customCols = userInput ? userInput.split(',').map(s=>s.trim()).filter(Boolean) : [];
          const colsToSummarize = [...new Set([...defaultCols, ...customCols])];

          const dashboardContent = document.getElementById('dashboardContent');

          if(currentRawData.length <= 1){
            dashboardContent.innerHTML = '<p style="text-align:center; padding:50px; color:#cc0000;">⚠️ Silakan unggah file Excel terlebih dahulu di tab Viewer Data.</p>';
            return;
          }

          const headers = currentRawData[0].map(h => String(h).toUpperCase());
          const dataRows = currentRawData.slice(1);

          let html = '<h3>Rekapitulasi Data Excel (Berdasarkan Total Baris Data)</h3>';

          colsToSummarize.forEach(colName=>{
            const upper = colName.toUpperCase();
            const idx = headers.indexOf(upper);

            if(idx === -1){
              html += `<div class="dashboard-card" style="background-color:#ffeaea; border-color:#ffcccc;">
                ⚠️ Kolom <strong>${colName}</strong> tidak ditemukan di data Excel.
              </div>`;
              return;
            }

            const breakdown = {};
            let total = 0;

            dataRows.forEach(r=>{
              const v = String(r[idx] ?? 'N/A').trim();
              breakdown[v] = (breakdown[v] || 0) + 1;
              total++;
            });

            html += `<div class="dashboard-card">
              <h4>Kolom: ${colName} (Total Entri: ${total} Baris)</h4>`;

            const entries = Object.entries(breakdown).sort((a,b)=>b[1]-a[1]);
            html += `<table class="breakdown-table">
              <thead><tr><th>Kategori (${colName})</th><th>Jumlah Baris</th><th>Persentase</th></tr></thead><tbody>`;

            entries.forEach(([cat,count])=>{
              const pct = total ? ((count/total)*100).toFixed(2) : "0.00";
              html += `<tr><td>${cat}</td><td>${count}</td><td>${pct}%</td></tr>`;
            });

            html += `</tbody></table></div>`;
          });

          dashboardContent.innerHTML = html;
        }

        // ===== Popup =====
        function openPopup(src){
          document.getElementById("popupImg").src = src;
          document.getElementById("popup").style.display = "flex";
          document.body.style.overflow = "hidden";
        }
        function closePopup(event){
          const popup = document.getElementById("popup");
          const closeBtn = document.getElementById("closeBtn");
          const popupImg = document.getElementById("popupImg");
          if(event.target===popup || event.target===closeBtn || event.target===popupImg){
            popup.style.display="none";
            document.body.style.overflow="";
          }
        }

        // ===== Runner modal =====
        function openRunModal(title){
          document.getElementById('runTitle').textContent = title || 'Menjalankan...';
          document.getElementById('runOutput').textContent = 'Menjalankan script...';
          const rc = document.getElementById('runCode');
          rc.textContent = 'RC: ...';
          rc.className = 'pill';
          document.getElementById('runModal').style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }
        function closeRunModal(evt){
          if(evt && evt.target && evt.target.id !== 'runModal') return;
          document.getElementById('runModal').style.display = 'none';
          document.body.style.overflow = '';
        }

        const TOOL_LABELS = {
          data_cust_new: "0 - Fix - Data Cust ACMT DLPD - UX - New.py",
          split_idpel: "1 - Fix - Split Idpel.py",
          download_foto: "2 - Fix - Download Foto ACMT.py",
          verifikasi_kwh: "3 - Fix - Verifikasi Fisik kWh Meter - TFLITE.py",
          filter_output_scan: "4 - Fix - Filter Output Scan.py",
        };

        async function runTool(toolKey){
          toggleSidebar(false);
          const label = TOOL_LABELS[toolKey] || toolKey;
          openRunModal(`Menjalankan: ${label}`);

          try{
            const res = await fetch(`/api/run/${encodeURIComponent(toolKey)}`, { method:'POST' });
            const data = await res.json().catch(()=> ({}));

            if(!res.ok){
              const msg = data.error || `HTTP ${res.status}`;
              throw new Error(msg);
            }

            const out = [];
            if(data.stdout) out.push("=== STDOUT ===\n" + data.stdout);
            if(data.stderr) out.push("\n=== STDERR ===\n" + data.stderr);

            document.getElementById('runOutput').textContent = out.join("\n") || "(Tidak ada output)";
            const rc = document.getElementById('runCode');
            rc.textContent = `RC: ${data.returncode}`;
            rc.className = `pill ${data.returncode === 0 ? 'ok' : 'err'}`;
          }catch(err){
            document.getElementById('runOutput').textContent =
              `Gagal menjalankan.\n\n` +
              `Kemungkinan penyebab:\n` +
              `- Backend belum jalan / hosting statis\n` +
              `- Endpoint /api/run/... tidak ada\n` +
              `- Script tidak ditemukan\n\n` +
              `Detail:\n${String(err)}`;

            const rc = document.getElementById('runCode');
            rc.textContent = 'RC: ERR';
            rc.className = 'pill err';
          }
        }

        // ===== Init =====
        document.addEventListener('DOMContentLoaded', ()=>{
          showTab('viewerTab');
          setSidebarActive('viewerTab');
          toggleScripts(false);
          toggleSidebar(false);

          initTopSearch();
        });
      </script>
    </main>
  </div>
</body>
</html>